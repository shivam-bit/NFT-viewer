import type { NextPage } from 'next';
import Head from 'next/head';
import { useRouter } from 'next/router';
import { useContext, useEffect } from 'react';
import { AppContext, UserContext } from 'src/context/';
import InfiniteScroll from 'react-infinite-scroll-component';
import styles from 'src/styles/Home.module.scss';
import {
  Button,
  ChainsMenu,
  NftCard,
  CollectionsSelect,
} from '../src/components';
import { GalleryGrid } from '/src/layout/';
import NftSDKInstance from '/src/services/NftSdk';
const Home: NextPage = () => {
  const { activateConfetti, isConnected, nftsLoading, setNftsLoading } =
    useContext(AppContext);
  const {
    walletAddress,
    activeChain,
    allCollections,
    activeCollections,
    nftsArray,
    setNftsArray,
    moreResultsAvailable,
    setMoreResultsAvailable,
  } = useContext(UserContext);

  const router = useRouter();

  const loadMoreNfts = () => {
    console.log('ðŸš€ ~ load more nfts');
    NftSDKInstance.getNext().then((response) => {
      console.log('ðŸš€ ~ file: view.tsx ~ line 46 ~.then ~ response', response);
      setNftsArray([...nftsArray, ...response.result]);
      setMoreResultsAvailable(NftSDKInstance.moreNftsAvailable());
    });
  };
  useEffect(() => {
    NftSDKInstance.getAllNFTsOfWallet(
      walletAddress,
      activeChain,
      activeCollections,
      allCollections
    ).then((response) => {
      setNftsArray([...response.result]);
      setMoreResultsAvailable(NftSDKInstance.moreNftsAvailable());
    });
  }, [activeCollections, activeChain]);

  useEffect(() => {
    if (!isConnected) router.replace('/');
  }, [isConnected]);

  return (
    <div className={styles.container}>
      <Head>
        <title>NFT Gallery</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <ChainsMenu />
      <CollectionsSelect />
      <main className={styles.main}>
        <InfiniteScroll
          dataLength={nftsArray.length} //This is important field to render the next data
          next={loadMoreNfts}
          hasMore={moreResultsAvailable}
          loader={<h4>Loading...</h4>}
          endMessage={
            <p style={{ textAlign: 'center' }}>
              <img src="/peace.gif" />
            </p>
          }
        >
          <GalleryGrid>
            {nftsArray.map((nft, index) => {
              const data = {
                ...nft.metadata,
                token_address: nft.token_address,
              };
              return <NftCard nftDta={data} name={nft.name} key={index} />;
            })}
          </GalleryGrid>
        </InfiniteScroll>
      </main>
    </div>
  );
};

export default Home;
